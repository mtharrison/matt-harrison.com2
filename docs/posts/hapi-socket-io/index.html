<!DOCTYPE html>




<html lang="en">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  
    
    Using hapi.js with Socket.io
  
 | Matt Harrison</title>



<link rel="stylesheet" href="/book.min.19b2fad70b59ba6d7af5b9f71e301499899fb2a0626d295a45d769a484a7ace9.css">


<link rel="icon" href="/favicon.png" type="image/x-icon">


<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  

  <link rel="stylesheet" href="/css/routeros.css">
  <link rel="stylesheet" href="/css/style.css">
  <script src="/js/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
</head>

<body>
  <input type="checkbox" style="display: none" id="menu-control" />
  <main class="flex container">
    <aside class="book-menu fixed">
      <nav role="navigation">
<div class="brand">
    <a href="https://matt-harrison.com/"><img class="profile-image" src="https://matt-harrison.com/content/images/2018/07/153180020555179787--1--2.gif" alt=""></a>
  <h2 class="book-brand"><a href="https://matt-harrison.com/">Matt Harrison</a></h2>
  <p>Software developer and author based in the UK.</p>

  <div class="linksBlock">
    <p><a href="http://twitter.com/mt_harrison"><s>Twitter</s></a></p>
    <p><a href="https://github.com/mtharrison">Github</a></p>
    <p><a href="http://stackoverflow.com/users/1402929/matt-harrison">Stack Overflow</a></p>
    
  </div>
</div>




    

  
  






  <ul>
  
  </ul>











</nav>



    </aside>

    <div class="book-posts">
      <header class="align-center justify-between book-header">
  <label for="menu-control">
    <img src="/svg/menu.svg" alt="Menu" />
  </label>
  <strong>
  
    
    Using hapi.js with Socket.io
  
</strong>
</header>

      

<header class="markdown">
  <h1>Using hapi.js with Socket.io</h1>
  <h5>
    <strong>March 3, 2015</strong>
  </h5>
</header>
<article class="markdown"><p>Socket.io and hapi.js are two great pieces of software for Node. There&rsquo;s no official documentation on how they work together though. I&rsquo;ve seen questions about this several times on Twitter and Github, so I thought I&rsquo;d write a quick tutorial to show just how easy it is to integrate the two.</p>
<h3 id="the-listener">The listener</h3>
<p>Every hapi server comes with a <code>listener</code> property:</p>
<pre><code>var Hapi = require('hapi');

var server = new Hapi.Server();
server.connection({ port: 4000 });

var listener = server.listener; // &lt;--- The listener
</code></pre>
<p>That <code>listener</code> object, in this case, is a node <code>http</code> (or <code>https</code>) server. Exactly the same as you would get from the following:</p>
<pre><code>var Http = require('http');

var listener = Http.createServer(function (req, res){
    ...
});
</code></pre>
<p>Whenever you create a new connection in hapi, it goes and creates a new <code>http</code> server for you internally. This gets set to <code>this.listener</code>.</p>
<h3 id="setting-up-socketio">Setting up Socket.io</h3>
<p>The offical Socket.io docs show how to set up socket.io when using a vanilla node <code>http</code> server.</p>
<pre><code>var handler = function (req, res) {
  ...
};

var app = require('http').createServer(handler);
var io = require('socket.io')(app); // &lt;--- what's this 'app' thing?

app.listen(80);
</code></pre>
<p>The <code>app</code> variable in the above example is an instance of a node <code>http</code> server, just like our hapi server&rsquo;s <code>listener</code>.</p>
<p>We can take this knowledge that socket.io can be initialized with an <code>http</code> server over to hapi:</p>
<pre><code>var Hapi = require('hapi');

var server = new Hapi.Server();
server.connection({ port: 4000 });

var io = require('socket.io')(server.listener);

io.on('connection', function (socket) {

    socket.emit('Oh hii!');

    socket.on('burp', function () {
        socket.emit('Excuse you!');
    });
});

server.start();
</code></pre>
<p>Pretty straightforward right? Socket.io will go and attach itself to the listener (server). You can make sure it&rsquo;s working by going to http://localhost:4000/socket.io/socket.io.js, you should see the socket.io client JS file being served.</p>
<h3 id="why-isnt-there-some-kind-of-conflict-between-hapi-and-socketio">Why isn&rsquo;t there some kind of conflict between hapi and socket.io?</h3>
<p>Every Node <code>http</code> server can have several listener (yeah&hellip;a different meaning of listener) functions for the <code>request</code> event. When you setup socket.io, it will remove all existing listeners (including the one added by hapi):</p>
<pre><code>var listeners = server.listeners('request').slice(0);
server.removeAllListeners('request');
</code></pre>
<p>By removing all existing listeners, socket.io is ensuring it gets to the request first.</p>
<p>But it will keep hold of any others and if it decides the request isn&rsquo;t intended for socket.io (i.e. the url doesn&rsquo;t start /socket.io), it will call those other listener function instead, giving control back to hapi.</p>
<h3 id="how-about-when-using-multiple-connections">How about when using multiple connections?</h3>
<p>A &ldquo;server&rdquo; in hapi is semantically different to a &ldquo;server&rdquo; in node. A server in hapi may be listening on several different ports all at once by using multiple connections.</p>
<p>If your hapi server has multiple connections, it really has multiple node <code>http</code> servers running for you in the background. The <code>listener</code> property of the hapi server is always going to point to the <code>http</code> server on the first connection. If you want to attach socket.io to a different connection, you can use labels and <code>server.select()</code>:</p>
<pre><code>var Hapi = require('hapi');

var server = new Hapi.Server();
server.connection({ port: 4000, labels: ['api'] });
server.connection({ port: 4001, labels: ['chat'] });

var io = require('socket.io')(server.select('chat').listener);

io.on('connection', function (socket) {

    socket.emit('Oh hii!');

    socket.on('burp', function () {
        socket.emit('Excuse you!');
    });
});

server.start();
</code></pre>
<h3 id="what-about-plugins">What about plugins?</h3>
<p>My favourite feature of hapi is plugins without a doubt. I love the way you can split up your concerns into separate modules. If I&rsquo;m using socket.io with hapi, I always embrace the plugin approach to split my realtime concerns into their own plugin.</p>
<pre><code>.
├── chat	&lt;--- My hapi plugin
│   ├── handlers.js
│   └── index.js
└── index.js
</code></pre>
<h5 id="indexjs">index.js</h5>
<pre><code>var Hapi = require('hapi');

var server = new Hapi.Server();

server.connection({ port: 4000, labels: ['api'] });
server.connection({ port: 4001, labels: ['chat'] });

server.register(require('./chat'), function (err) {

    if (err) {
        throw err;
    }

    server.start();
});
</code></pre>
<h5 id="chatindexjs">chat/index.js</h5>
<pre><code>var Handlers = require('./handlers');

exports.register = function (server, options, next) {

    var io = require('socket.io')(server.select('chat').listener);

    io.on('connection', function (socket) {

        console.log('New connection!');

        socket.on('hello', Handlers.hello);
        socket.on('newMessage', Handlers.newMessage);
        socket.on('goodbye', Handlers.goodbye);
    });

    next();
};

exports.register.attributes = {
    name: 'hapi-chat'
};
</code></pre>
<h5 id="chathandlersjs-socketio-is-kind-enough-to-bind-your-handlers-to-the-socket-so-this-is-equal-to-the-socket-object">chat/handlers.js (socket.io is kind enough to bind your handlers to the socket so <code>this</code> is equal to the socket object)</h5>
<pre><code>exports.hello = function () {

    this.emit('Hi back at you');
};

exports.newMessage = function (newMessage) {

    console.log('Got message', newMessage);
};

exports.goodbye = function () {

    this.emit('Take it easy, pal');
};
</code></pre>
<p>I find this is a really clean approach to divide up apps that use both hapi and socket.io.</p>
<h3 id="thats-it">That&rsquo;s it!</h3>
<p>I hope this short tutorial has been of some help you to. If you&rsquo;ve any suggestestions or corrections, please leave a comment or get me at @mt_harrison.</p>
<h3 id="the-book">The book</h3>
<!-- raw HTML omitted -->
<p><!-- raw HTML omitted -->I&rsquo;m currently in the process of writing a book about hapi. <!-- raw HTML omitted -->Hapi.js in Action<!-- raw HTML omitted --> is available now as a MEAP from Manning Publications. Use my author code <!-- raw HTML omitted -->mlharrison<!-- raw HTML omitted --> to get 50% off, for a limited time only.</p>
<!-- raw HTML omitted -->
</article>

      
    </div>
  </main>

  
  

  
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-49752272-2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-49752272-2');
  </script>
</body>

</html>
